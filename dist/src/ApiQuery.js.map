{"version":3,"file":"ApiQuery.js","sourceRoot":"","sources":["../../src/ApiQuery.ts"],"names":[],"mappings":";AAAA,2BAAsE,UAAU,CAAC,CAAA;AAWjF;IAAA;QACI,UAAK,GAAgB,EAAE,CAAC;QAExB,YAAO,GAAG,CAAC,IAAe;YACtB,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;YACzB,MAAM,CAAC,IAAI,CAAA;QACf,CAAC,CAAC;QAEF,SAAI,GAAG,CAAC,IAAe;YACnB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACtB,MAAM,CAAC,IAAI,CAAA;QACf,CAAC,CAAC;QAEF,YAAO,GAAG;YACN,MAAM,CAAC,IAAI,OAAO,CAAuB,CAAC,OAAO,EAAE,MAAM;gBACrD,IAAI,IAAI,GAAG,CAAC,KAAiB;oBACzB,IAAI,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC;oBAC9B,EAAE,CAAA,CAAC,IAAI,CAAC,CAAC,CAAC;wBACN,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;4BACpB,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;wBACjD,CAAC;wBACD,IAAI,CAAC,CAAC;4BACF,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,KAAK,IAAI,OAAO,CAAC,KAAK,CAAC,QAAQ,IAAI,IAAI,+BAAoB,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;wBAC/G,CAAC;oBACL,CAAC;gBACL,CAAC,CAAC;gBAEF,IAAI,CAAC,EAAE,OAAO,EAAE,IAAI,8BAAmB,EAAE,EAAE,QAAQ,EAAE,IAAI,EAAC,CAAC,CAAC;YAChE,CAAC,CAAC,CAAA;QACN,CAAC,CAAA;IACL,CAAC;AAAD,CAAC;AA9BY,gBAAQ,WA8BpB,CAAA","sourcesContent":["import {ApiEdgeQuery, ApiEdgeQueryContext, ApiEdgeQueryResponse} from \"api-core\";\n\nexport interface QueryScope {\n    context: ApiEdgeQueryContext,\n    response: ApiEdgeQueryResponse|null\n}\n\nexport interface QueryStep {\n    execute(scope: QueryScope): Promise<QueryScope>;\n}\n\nexport class ApiQuery {\n    steps: QueryStep[] = [];\n\n    unshift = (step: QueryStep): ApiQuery => {\n        this.steps.unshift(step);\n        return this\n    };\n\n    push = (step: QueryStep): ApiQuery => {\n        this.steps.push(step);\n        return this\n    };\n\n    execute = (): Promise<ApiEdgeQueryResponse> => {\n        return new Promise<ApiEdgeQueryResponse>((resolve, reject) => {\n            let next = (scope: QueryScope) => {\n                let step = this.steps.shift();\n                if(step) {\n                    if (this.steps.length) {\n                        step.execute(scope).then(next).catch(reject);\n                    }\n                    else {\n                        step.execute(scope).then(scope => resolve(scope.response || new ApiEdgeQueryResponse(null))).catch(reject);\n                    }\n                }\n            };\n\n            next({ context: new ApiEdgeQueryContext(), response: null});\n        })\n    }\n}\n"]}